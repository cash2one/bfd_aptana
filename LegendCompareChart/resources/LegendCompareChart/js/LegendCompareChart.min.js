function LegendCompareChart(i,h,d){function k(){function a(e,c,i){e={cols:$.map(h.items,function(b){return b.key}),limits:{dataRange:{start:e,end:c},option:h.menuItem.data}};$.ajax({url:h.menuItem.url,dataType:"json",data:e}).done(function(c){for(var a in b.vDoms)b.vDoms[a].eq(i).html(c[a])})}var b=this;b.vDoms={};b.flush=function(){for(var e in b.vDoms)b.vDoms[e].html("loading...");a(d.begin,d.end,0);"single"!=d.mode&&a(d.dbBegin,d.dbEnd,1)};b.init=function(){var a=function(c){$.each(h.items,function(a,
e){var d=100/h.items.length,j=$("<td></td>");j.css("width",d+"%");d=$("<div></div>").click(function(){if(!$(this).hasClass("groupnow")){$(i).find(".z").find("tr").find("div.groupnow").removeClass("groupnow").addClass("group");var a=$(this).parent().index();$(i).find(".z").find("tr").find("td:eq("+a+") > div").addClass("groupnow");b.currentItem=e;b.change()}});e.checked&&$.isEmptyObject(b.currentItem)?(b.currentItem=e,d.addClass("groupnow")):d.addClass("group");var g=$("<div></div>",{"class":"tittle",
html:'<div class="txt">'+e.title+'</div><a class="ico" href="#"></a>'});g.find("a").qtip({content:e.desc,style:{name:"blue"},position:{corner:{target:"topMiddle",tooltip:0==a?"leftBottom":a==h.items.length-1?"rightBottom":"bottomMiddle"}},style:{background:"#F0F5F9",color:"#999999",border:{color:"#267BB6"}}});var l=$("<div></div>",{"class":"value",text:"loading..."});b.vDoms[e.key]?b.vDoms[e.key].add(l):b.vDoms[e.key]=l;a===h.items.length-1&&d.css("background-image","none");d.append(g).append(l).appendTo(j);
j.appendTo(c)})},c=$('<table cellspacing="0" cellpadding="0" border="0" class="data01"><tbody><tr><td class="l"></td><td class="z"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr></tr></tbody></table> </td><td class="r"></td></tr></tbody></table>');b.items=h.items;var d=c.clone().addClass("data01_01").hide();a(c.find(".z tr"));a(d.find(".z tr"));c.appendTo($(i));d.appendTo($(i));b.flush()};b.init()}function n(a){var b=this;b.dom=$(i).find(".data02 >.top >.data_select >select");
b.currentDbItem={};b.bindEvent=function(){b.dom.change(function(){$(this).val()===$(this).find("option:first").val()?b.currentDbItem={}:$.each(h.items,$.proxy(function(a,c){$(this).val()==c.key&&(b.currentDbItem=c)},this));b.change()})};b.flush=function(){b.currentDbItem={};b.dom.find("option:gt(0)").remove();$.each(a.items,$.proxy(function(e,c){c.key!=a.currentItem.key&&$("<option></option>",{value:c.key,text:c.title}).appendTo(b.dom)},b))};b.init=function(){b.flush();this.bindEvent()};b.init()}
function o(a,b,e,c,d){var f=this;f.flush=function(){f.chart.showLoading();var a=function(a,g,m,k){$.ajax({async:!0,url:d.chart.url,data:{cols:m,groupBy:["date"],limits:{dataRange:{start:a,end:g},option:d.chart.data}},dataType:"json",success:function(a){h++;0==k?i=a.stores:j=a.stores;if("compare"===b.mode&&2==h||"compare"!=b.mode&&1==h){h=0;a={};a.type=$.map(i,function(a){return a[e.currentItem.key]});$.isEmptyObject(c.currentDbItem)||(a.dbtype=$.map(i,function(a){return a[c.currentDbItem.key]}));
"compare"===b.mode&&(a.type2=$.map(j,function(a){return a[e.currentItem.key]}));!$.isEmptyObject(c.currentDbItem)&&"compare"===b.mode&&(a.dbtype2=$.map(j,function(a){return a[c.currentDbItem.key]}),console.info(a));f.chart.yAxis[0].setTitle({text:e.currentItem.title},!1);f.chart.yAxis[1].setTitle({text:$.isEmptyObject(c.currentDbItem)?null:c.currentDbItem.title},!1);for(var d=b.begin.split("-"),g;0<f.chart.series.length;)f.chart.series[0].remove(!1);f.chart.addSeries({name:e.currentItem.title,marker:{symbol:"circle",
radius:5},color:"#609EC8",data:a.type,pointInterval:864E5,xAxis:0,yAxis:0,pointStart:Date.UTC(d[0],parseInt(d[1],10)-1,d[2])},!1);$.isEmptyObject(c.currentDbItem)||f.chart.addSeries({name:c.currentDbItem.title,marker:{symbol:"circle",radius:5},color:"#A6C71E",data:a.dbtype,pointInterval:864E5,xAxis:0,yAxis:1,pointStart:Date.UTC(d[0],parseInt(d[1],10)-1,d[2])},!1);"compare"===b.mode&&(g=b.dbBegin.split("-"),f.chart.addSeries({name:e.currentItem.title+"(\u5bf9\u6bd4\u65f6\u95f4\u6bb5)",marker:{symbol:"square",
radius:5},color:"#C3E3F8",data:a.type2,pointInterval:864E5,xAxis:1,yAxis:0,pointStart:Date.UTC(g[0],parseInt(g[1],10)-1,g[2])},!1));!$.isEmptyObject(c.currentDbItem)&&"compare"===b.mode&&f.chart.addSeries({name:c.currentDbItem.title+"(\u5bf9\u6bd4\u65f6\u95f4\u6bb5)",marker:{symbol:"square",radius:5},color:"#DCF185",data:a.dbtype2,pointInterval:864E5,xAxis:1,yAxis:1,pointStart:Date.UTC(g[0],parseInt(g[1],10)-1,g[2])},!1);f.chart.redraw();f.chart.hideLoading()}}})},h=0,i,j,g=[e.currentItem.key];$.isEmptyObject(c.currentDbItem)||
g.push(c.currentDbItem.key);a(b.begin,b.end,g,0);"compare"===b.mode&&a(b.dbBegin,b.dbEnd,g,1)};f.init=function(){f.chart=new Highcharts.Chart({chart:{renderTo:$(a)[0],marginRight:60,events:{redraw:function(){"compare"===b.mode?(f.chart.xAxis[1].showAxis=!0,f.chart.xAxis[1].axisTitle.show()):(f.chart.xAxis[1].showAxis=!1,f.chart.xAxis[1].axisTitle.hide(),f.chart.xAxis[1].redraw())}},zoomType:""},lang:{loading:"\u52a0\u8f7d\u4e2d..."},credits:{enabled:!1},title:{text:null},tooltip:{formatter:function(){var a=
new Date(this.x);return"\u65e5\u671f:"+a.getUTCFullYear()+"-"+(parseInt(a.getUTCMonth(),10)+1)+"-"+a.getUTCDate()+"<br/><b>"+this.series.yAxis.axisTitle.text+":"+this.point.y+"</b>"}},xAxis:[{type:"datetime",title:{text:"\u5f53\u524d\u65f6\u95f4\u6bb5",style:{color:"#000"}},dateTimeLabelFormats:{day:"%Y-%m-%e"},tickInterval:864E5,tickmarkPlacement:"on",showLastLabel:!0,showFirstLabel:!0},{type:"datetime",title:{text:"\u5bf9\u6bd4\u65f6\u95f4\u6bb5",style:{color:"#000"}},dateTimeLabelFormats:{day:"%Y-%m-%e"},
tickInterval:864E5,tickmarkPlacement:"on",showLastLabel:!0,showFirstLabel:!0,opposite:!0}],yAxis:[{title:{style:{color:"#609EC8"},text:null},lineColor:"#609EC8"},{title:{style:{color:"#A6C71E"},text:null},lineColor:"#A6C71E",opposite:!0}],series:[{color:"#609EC8",data:[],pointInterval:864E5,xAxis:0,yAxis:0},{color:"#A6C71E",data:[],pointInterval:864E5,xAxis:0,yAxis:1},{color:"#C3E3F8",data:[],pointInterval:864E5,xAxis:1,yAxis:0},{color:"#DCF185",data:[],pointInterval:864E5,xAxis:1,yAxis:1}]});f.flush()};
f.init()}var a=this;a.flush=function(){a.menuItem.flush();a.chart.flush()};a.init=function(){a.menuItem=new k;$(i).append($('<div class="data02"><div class="top"><div class="data_select"><select name="compare" style="display: inline;"><option>\u5bf9\u6bd4\u6307\u6807</option></select></div></div><div class="tubiao"></div></div>'));a.menuItemCompare=new n(a.menuItem);a.chart=new o($(i).find(".tubiao"),d,a.menuItem,a.menuItemCompare,h);a.menuItem.change=function(){a.menuItemCompare.flush();a.chart.flush()};
a.menuItemCompare.change=function(){a.chart.flush()};d.addEventListener(function(){a.flush()})};a.init()};
